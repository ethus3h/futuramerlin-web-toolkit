#!/usr/bin/env bash
# shellcheck disable=SC1091
source ember_bash_setup &> /dev/null || { printf '%b' '\033[1;31m' >&2; echo "A fatal error was reported on ${BASH_SOURCE[0]} line ${LINENO} in $(pwd): The required dependency ember-shared could not be found (or ember_bash_setup could not be sourced for some other reason)." >&2; printf '%b' '\033[0m' >&2; exit 1; }
#set -x

trap 'die "A fatal error was reported on ${BASH_SOURCE[0]} line ${LINENO} in $(pwd) at $(emdate)."' ERR

# Convert a fmwtk simple-format page to the more html-like fmwtk format
# Usage: fmwtk-convpage [page] [output-file]

infile="$1"
outfile="$2"
stdout="false"
if [[ "-" == "$outfile" ]]; then
    outfile="$(tempFile)"
    stdout="true"
fi

cp "$infile" "$outfile"

perl -0777 -p -i -e '
    s/(\n\s*[^-\n]*\n)(\s*- )/\1<ul>\n\2/g; # ul start tags
    s/(\n\s*[^#\n]*\n)(\s*# )/\1<ul>\n\2/g; # ol start tags
    s/(\n\s*- [^\n]*\n)(\s*[^-][^ ][^\n]*\n)/\1<\/ul>\n\2/g; # ul end tags
    s/(\n\s*# [^\n]*\n)(\s*[^#][^ ][^\n]*\n)/\1<\/ul>\n\2/g; # ol end tags
    s/(\n\s*)- ([^\n]*)\n/\1<li>\2</li>\n/g; # li tags in ul
    s/(\n\s*)# ([^\n]*)\n/\1<li>\2</li>\n/g; # li tags in ol
    s/^(\s*)([^<])$/\1<p>\2</p>/g; # paragraph tags
    ' "$outfile" || die "Substitution failed"

if [[ "true" == "$stdout" ]]; then
    cat "$outfile"
fi
