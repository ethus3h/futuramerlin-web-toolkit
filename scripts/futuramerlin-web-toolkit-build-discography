#!/bin/bash
# shellcheck disable=SC1091
source ember_bash_setup &> /dev/null
trap 'die "A fatal error was reported on ${BASH_SOURCE[0]} line ${LINENO}."' ERR

if [[ ! -f "futuramerlin-web-toolkit-discography.conf" ]]; then
    die "Couldn't find discography configuration file!"
fi

# Where the discography assets are located
da="/usr/local/share/futuramerlin-web-toolkit/assets/discography.assets"

# Breadcrumbs prefix
breadcrumbs="$(<futuramerlin-web-toolkit-discography.breadcrumbs)"

# Build main index page
discographyPageName="$(preadconf filename futuramerlin-web-toolkit-discography.conf)"
cp "$da/index.htm" "./$discographyPageName.htm"
ereplace "@BREADCRUMBS@" "$breadcrumbs" "$da/index.htm"

function listItem() {
    print "<li><a href=\"$1\">$2</a></li>"
}
export -f listItem

# Get a list of artists, and make the artists index page
function buildIndex() {
(
    cd artists || die
    declare -a artists
    count=0
    for artist in *.conf; do
        artists[$count]="${artist%.conf}"
        count=$(( count + 1 ))
    done
    export artists

    # Build artists index page
    cp "$da/index-template.htm" index.htm
    ereplace "@TITLE@" "Artists" index.htm
    ereplace "@BREADCRUMBS@" "$breadcrumbs<span><a href=\"../$discographyPageName.htm\">Discography</a></span>" index.htm
    artistList=""
    for artist in "${artists[@]}"; do
        name="$(preadconf name "$artist.conf")"
        artistList="$artistList$(listItem "$artist" "$name")"
    done
    ereplace "@LIST@" "$artistList" index.htm
)
}
export -f buildIndex
