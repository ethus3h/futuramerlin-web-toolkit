#!/bin/bash
# shellcheck disable=SC1091
source ember_bash_setup &> /dev/null
trap 'die "A fatal error was reported on ${BASH_SOURCE[0]} line ${LINENO}."' ERR

if [[ ! -f "futuramerlin-web-toolkit-discography.conf" ]]; then
    die "Couldn't find discography configuration file!"
fi

# Where the discography assets are located
da="/usr/local/share/futuramerlin-web-toolkit/assets/discography.assets"

# Variables
breadcrumbs="$(<futuramerlin-web-toolkit-discography.breadcrumbs)"
discographyPageName="$(preadconf filename futuramerlin-web-toolkit-discography.conf)"

function listItem() {
    picture=""
    if [[ "$3" == "true" && -e "$1.t.png" ]]; then
        picture="<img src=\"$1.t.png\" alt=\"$2: album artwork thumbnail\" /> "
    fi
    print "<li><a href=\"$1.htm\">$picture$2</a></li>"
}
export -f listItem

function buildIndex() {
    includePictures="true"
    if [[ "$2" == "false" ]]; then
        includePictures=""
    fi
    (
        cd "$1" || exit 0 # it's ok if the directory doesn't exist; that just means that that category of things isn't present in the discography
        declare -a "$1"
        count=0
        for item in *.conf; do
            "$1"[$count]="${item%.conf}"
            count=$(( count + 1 ))
        done
        # shellcheck disable=SC2163
        export "$1"

        # Build index page
        cp "$da/index-template.htm" index.htm
        ereplace "@TITLE@" "${1^}" index.htm
        ereplace "@BREADCRUMBS@" "$breadcrumbs<span><a href=\"../$discographyPageName.htm\">Discography</a></span>" index.htm
        itemList=""
        for item in "${$1[@]}"; do
            name="$(preadconf name "$item.conf")"
            itemList="$itemList$(listItem "$item" "$name" "$includePictures")"
        done
        ereplace "@LIST@" "$itemList" index.htm
    )
}
export -f buildIndex

cp "$da/index-template.htm" "./$discographyPageName.htm"
ereplace "@TITLE@" "Discography" index.htm
ereplace "@BREADCRUMBS@" "$breadcrumbs" "$discographyPageName.htm"
itemList=""
for item in (artists broadcasts files labels releases sessions works); do
    if [[ -e "$item" ]]; then
        buildIndex "$item"
        itemList="$itemList$(listItem "$item" "${item^}")"
    fi
done
