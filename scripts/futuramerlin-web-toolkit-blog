#!/usr/bin/env bash
# shellcheck disable=SC1091
source ember_bash_setup &> /dev/null
trap 'die "A fatal error was reported on ${BASH_SOURCE[0]} line ${LINENO}."' ERR

set -x

sourceDir="$(readlink -f "$1")"

destDir="$(readlink -f "$2")"

maxPostsPerPage="5"

[[ -e "$destDir" ]] && rm -r "$destDir"

rsync -a --checksum "$sourceDir/" "$destDir"

cd "$destDir" || die

# Count the number of posts

numPosts="$(find "$destDir" -type f -name "*.htm" -printf '.' | wc -c)"

makeIndexPage() {
    if [[ "$numPosts" -gt "$maxPostsPerPage" ]]; then
        # Create redirect page
        mkdir "$currentPageNumber"
        if [[ "$currentPageNumber" == "1" ]]; then
            echo '<!DOCTYPE html> <html lang="en"> <head> <meta charset="utf-8"> <meta http-equiv="refresh" content="0; url=../"> </head> <body> </body> </html>' > "$currentPageNumber/index.html"
        else
            echo '<!DOCTYPE html> <html lang="en"> <head> <meta charset="utf-8"> <meta http-equiv="refresh" content="0; url=../page-'"$currentPageNumber"'.htm"> </head> <body> </body> </html>' > "$currentPageNumber/index.html"
        fi
    fi
    
    # Create actual index page
    local indexPageName="page-$currentPageNumber.htm"
    if [[ "$currentPageNumber" == "1" ]]; then
        indexPageName="index.htm"
    fi
    printf '%s\n\n' '<h1 class="title">Ember Blog</h1>' > "$indexPageName"

    # Pagination widget
    if [[ "$numPosts" -gt "$maxPostsPerPage" ]]; then
        # Make pagination widget, because there are more than one page
        echo '<footer class="pagination">' >> "$indexPageName"
        echo '    <ul>' >> "$indexPageName"
        if [[ "$currentPageNumber" != "1" ]]; then
            echo '        <li><a class="prev page-numbers" href="'$(( currentPageNumber - 1 ))'/">&laquo; Previous</a></li>' >> "$indexPageName"
        fi
        echo '        <li><span class="page-numbers current">'"$currentPageNumber"'</span></li>' >> "$indexPageName"
        if [[ "$numPostsRemaining" -gt "$maxPostsPerPage" ]]; then
            echo '        <li><a class="next page-numbers" href="'$(( currentPageNumber + 1 ))'/">Next &raquo;</a></li>' >> "$indexPageName"
        fi
        echo '        <li>' >> "$indexPageName"
        echo '            <form class="wpsp-page-nav-form" action="./" method="get">' >> "$indexPageName"
        echo '                <input class="wpsp-input-number" type="text" placeholder="Jump to" size="6" name="paged" />' >> "$indexPageName"
        echo '                <input class="wpsp-button" value="Go" type="submit" >' >> "$indexPageName"
        echo '            </form>' >> "$indexPageName"
        echo '        </li>' >> "$indexPageName"
        echo '    </ul>' >> "$indexPageName"
        echo '</footer>' >> "$indexPageName"
    fi
}

numPostsRemaining="$numPosts"
currentPageNumber="1"
while [[ "$numPostsRemaining" -gt "$maxPostsPerPage" ]]; do
    makeIndexPage
    numPostsRemaining=$(( numPostsRemaining - 5 ))
    currentPageNumber=$(( currentPageNumber + 1 ))
done
# Last (or only) page
makeIndexPage

echo "built" > ".futuramerlin-web-toolkit-blog.conf"
